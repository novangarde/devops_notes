
## needs

Используется для указания зависимостей между задачами в пайплайне. Она позволяет задаче начать выполнение немедленно после завершения указанных зависимостей, не ожидая окончания всех задач на текущем этапе. Это способствует параллельному выполнению и может значительно сократить общее время выполнения пайплайна.

```YAML
job1:
  stage: build
  script:
    - echo "Building..."

job2:
  stage: test
  needs: ["job1"]
  script:
    - echo "Testing..."
```

## script

Этап **script** в GitLab CI/CD — это часть задачи (job), где указываются команды, которые необходимо выполнить во время пайплайна. Этот этап является обязательным для каждой задачи и определяет набор команд, которые будут выполнены последовательно.

### Основные функции этапа script:

1. **Выполнение команд**: В секции **script** перечисляются команды, которые будут выполнены в контейнере, запущенном GitLab Runner.
2. **Последовательное выполнение**: Команды выполняются одна за другой. Если какая-либо команда завершится с ошибкой, задача будет считаться неудачной, если не указано иное (например, с помощью **allow_failure**).
3. **Доступ к переменным**: В скрипте доступны все переменные окружения, определенные в `.gitlab-ci.yml` или в настройках проекта GitLab.

```YAML
job1:
  stage: build
  script:
    - echo "Starting build..."
    - make build
    - echo "Build completed."
```

## rules

В GitLab CI/CD директива **rules** используется для определения условий выполнения задания (job). Она предоставляет гибкий способ настройки поведения задач в пайплайне, заменяя устаревшие ключи `only` и `except`.

Директива `rules` позволяет задать условия, при которых задание будет выполняться, пропускаться или запускаться вручную. Одним из таких условий является параметр **`when: manual`**, который указывает, что задание должно быть запущено только вручную.

```YAML
deploy_to_production:
  stage: deploy
  script:
    - echo "Deploying to production..."
  rules:
    - when: manual
```

Альтернативные параметры:
1. **on_success**: Задача запускается, если все предыдущие задачи завершились успешно.
2. **on_failure**: Задача запускается, если хотя бы одна предыдущая задача завершилась с ошибкой.
3. **always**: Задача запускается всегда, независимо от результатов предыдущих задач.
4. **delayed**: Откладывает запуск задачи на указанное время.
5. **never**: Задача никогда не запускается.

```YAML
job1:
  stage: build
  script:
    - echo "Building..."
  when: on_success

job2:
  stage: deploy
  script:
    - echo "Deploying..."
  when: on_failure

job3:
  stage: cleanup
  script:
    - echo "Cleaning up..."
  when: always

job4:
  stage: delayed
  script:
    - echo "Delayed task..."
  when: delayed
  start_in: 1 minute

job5:
  stage: never_run
  script:
    - echo "This will never run..."
  when: never
```

## expire_in

В GitLab CI/CD директива **`expire_in`** используется для указания срока хранения артефактов. Артефакты — это файлы или директории, которые сохраняются после выполнения задачи (job) и могут быть доступны для последующих задач или для скачивания.

Эта директива указывает, что артефакты будут храниться в течение **10 дней** после их создания. После истечения этого срока артефакты будут автоматически удалены.

```Shell
job:
  stage: build
  script:
    - echo "Building..."
  artifacts:
    paths:
      - build/
    expire_in: 10 days
```

Варианты указания срока:
- **`1 week`**
- **`3 days`**
- **`2 months`**
- **`1 year`**
- **`47 years and 6 months and 4 days`** (поддерживаются сложные указания сроков)