
**Iptables** — это мощный инструмент для управления сетевой безопасностью в Linux. Он позволяет фильтровать сетевой трафик, блокировать нежелательные пакеты и настраивать правила для защиты серверов и сетей.

## Иерархия IPTABLES

1. **Таблицы**:
    - Это верхний уровень иерархии. Таблицы — это логические контейнеры, которые группируют цепочки правил для обработки пакетов.
    - Основные таблицы: **filter**, **nat**, **mangle**, **raw**.

2. **Цепочки**:
    - Цепочки находятся внутри таблиц и представляют собой последовательности правил, которые применяются к пакетам.
    - Каждая таблица содержит свои встроенные цепочки:
        - **filter**: INPUT, FORWARD, OUTPUT.
        - **nat**: PREROUTING, OUTPUT, POSTROUTING.
        - **mangle**: PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING.
        - **raw**: PREROUTING, OUTPUT.

3. **Правила**:
    - Правила — это отдельные инструкции внутри цепочек, которые определяют условия и действия для пакетов.

## Цепочки

**Цепочки в IPTABLES** — это последовательности правил, которые применяются к пакетам данных для их фильтрации, маршрутизации или модификации. Каждая цепочка обрабатывает пакеты в зависимости от их назначения и источника.

1. **PREROUTING**: Обрабатывает входящие пакеты до их маршрутизации, независимо от того, предназначены ли они для текущей системы или проходят через нее. Это означает, что пакеты еще не прошли через таблицу маршрутизации и не были определены как входящие или проходящие.
2. **INPUT**: Обрабатывает пакеты, которые предназначены для текущей системы.
3. **FORWARD**: Обрабатывает пакеты, которые проходят через систему, но не предназначены для нее.
4. **OUTPUT**: Обрабатывает пакеты, которые отправляются с текущей системы.
5. **POSTROUTING**: Обрабатывает исходящие пакеты после их маршрутизации. Это означает, что пакеты уже прошли через таблицу маршрутизации и были определены как исходящие.

Помимо стандартных цепочек, можно создавать пользовательские цепочки для более гибкого управления правилами. Например, можно создать цепочку для блокировки трафика от определенного IP-адреса и подключить ее к основной цепочке INPUT.

Пример создания пользовательской цепочки:

```Shell
iptables -N MY_CHAIN
iptables -A MY_CHAIN -s 192.168.0.100 -j DROP
iptables -A INPUT -j MY_CHAIN
```

## Таблицы

Таблицы — это совокупности цепочек, которые содержат правила для обработки пакетов. Каждая таблица содержит набор цепочек, которые представляют собой последовательности правил. Эти правила состоят из критериев, действий и счетчиков, позволяя гибко настраивать обработку сетевых пакетов.

1. **filter**:
    - **Назначение**: Основная таблица для фильтрации пакетов. Используется по умолчанию, если не указана другая таблица.
    - **Цепочки**: INPUT (входящие пакеты), OUTPUT (исходящие пакеты), FORWARD (проходящие пакеты).

2. **nat**:
    - **Назначение**: Используется для настройки NAT (Network Address Translation), когда сервер выступает в качестве маршрутизатора.
    - **Цепочки**: PREROUTING, OUTPUT, POSTROUTING.

3. **mangle**:
    - **Назначение**: Используется для специальной обработки пакетов, например, для изменения полей пакетов.
    - **Цепочки**: PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING.

4. **raw**:
    - **Назначение**: Используется для обхода системы отслеживания состояний, когда пакеты обрабатываются как отдельные сущности.
    - **Цепочки**: PREROUTING, OUTPUT.

5. **security** (не всегда доступна):
    - **Назначение**: Используется для применения правил безопасности, таких как SELinux.
    - **Цепочки**: INPUT, OUTPUT, FORWARD.

## Правила

Правила в IPTABLES — это фундаментальная часть системы, которая позволяет администраторам настраивать обработку сетевых пакетов в соответствии с определенными критериями. Каждое правило состоит из трех основных компонентов:

1. **Критерий (условие)**: Определяет, какие пакеты будут обрабатываться по этому правилу. Критерии могут включать в себя тип протокола (TCP, UDP, ICMP), номер порта, IP-адрес источника или назначения и многое другое.

2. **Действие (цель)**: Определяет, что будет сделано с пакетом, если он соответствует критериям. Основные действия включают:
    - **ACCEPT**: Пропустить пакет.
    - **DROP**: Отбросить пакет без уведомления отправителя.
    - **REJECT**: Отклонить пакет с уведомлением отправителя.
    - **LOG**: Записать информацию о пакете в лог-файл.

3. **Счетчик**: Служит для отслеживания количества пакетов, обработанных по этому правилу.

```Shell
iptables -A INPUT -p tcp --destination-port 80 -m iprange --src-range 192.168.15.10-192.168.15.50 -j ACCEPT
```

Это правило добавляет новое правило в цепочку INPUT, разрешающее подключения к порту 80 (Apache) для IP-адресов в диапазоне от 192.168.15.10 до 192.168.15.50.

## Команды

| Полный вид       | Сокращенный вид | Описание                                                                               |
| ---------------- | --------------- | -------------------------------------------------------------------------------------- |
| `--append`       | `-A`            | Добавить правило в конец указанной цепочки.                                            |
| `--check`        | `-C`            | Проверить существующие правила в заданной цепочке.                                     |
| `--delete`       | `-D`            | Удалить правило с указанным номером в заданной цепочке.                                |
| `--insert`       | `-I`            | Вставить правило с заданным номером. Без указания номера — правило добавляется первым. |
| `--replace`      | `-R`            | Заменить правило с указанным номером.                                                  |
| `--list`         | `-L`            | Вывести список всех действующих правил.                                                |
| `--list-rules`   | `-S`            | Построчный вывод всех правил во всех цепочках.                                         |
| `--flush`        | `-F`            | Удалить все правила.                                                                   |
| `--zero`         | `-Z`            | Обнулить все счетчики.                                                                 |
| `--new`          | `-N`            | Создать пользовательскую цепочку.                                                      |
| `--delete-chain` | `-X`            | Удалить пользовательскую цепочку.                                                      |
| `--policy`       | `-P`            | Установить политику по умолчанию для цепочки.                                          |
| `--rename-chain` | `-E`            | Переименовать цепочку.                                                                 |
| `--help`         | `-h`            | Вывести справочную информацию по синтаксису iptables.                                  |

## MASQUERADE

**MASQUERADE в IPTABLES** — это цель, используемая в таблице NAT для преобразования исходного IP-адреса пакетов, исходящих из частной сети, в IP-адрес внешнего интерфейса маршрутизатора. Это позволяет устройствам в частной сети использовать один общий публичный IP-адрес для доступа к Интернету без необходимости иметь каждый свой публичный IP-адрес.

1. **Пакеты из частной сети**: Когда пакеты из частной сети отправляются в Интернет, они проходят через маршрутизатор с настроенным MASQUERADE.
2. **Преобразование адреса**: MASQUERADE меняет исходный IP-адрес пакета на IP-адрес внешнего интерфейса маршрутизатора.
3. **Модификация порта**: Для отслеживания соединений также модифицируется исходный порт пакета.
4. **Отправка пакета**: Пакет отправляется в Интернет с публичным IP-адресом маршрутизатора.
5. **Возвращение пакета**: Когда ответный пакет возвращается, маршрутизатор определяет его по измененному порту и возвращает пакет в исходную частную сеть, переводя публичный IP-адрес обратно на исходный частный IP-адрес.

```Shell
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

## SNAT

SNAT (Source Network Address Translation) — это механизм, используемый для преобразования адреса источника пакета при его выходе из локальной сети в Интернет. Это необходимо, когда несколько устройств в локальной сети используют один и тот же внешний IP-адрес для доступа к Интернету.

В IPTABLES ==SNAT используется для изменения адреса источника пакета при его выходе из локальной сети в Интернет.== Это необходимо, когда несколько устройств в локальной сети используют один и тот же внешний IP-адрес для доступа к Интернету.

SNAT изменяет IP-адрес источника пакета на внешний IP-адрес маршрутизатора или сервера, который выполняет NAT. Это позволяет пакетам от нескольких внутренних устройств проходить через Интернет, используя один внешний IP-адрес.

Доступен в PREROUTING и POSTROUTING.